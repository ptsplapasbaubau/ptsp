<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTSP LAPAS KELAS IIA BAUBAU - Sistem Pendaftaran Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a4d8c;
            --secondary-color: #e8a317;
            --accent-color: #2e6ab1;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 10px;
            --box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .logo-text h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: var(--secondary-color);
            color: #000;
        }
        
        .btn-primary:hover {
            background: #d18f0e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-outline {
            background: transparent;
            color: white;
            border: 2px solid white;
        }
        
        .btn-outline:hover {
            background: white;
            color: var(--primary-color);
        }
        
        /* Session Warning */
        .session-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        
        /* Hero Section */
        .hero {
            padding: 80px 0;
            background: linear-gradient(rgba(26, 77, 140, 0.9), rgba(26, 77, 140, 0.85)), 
                        url('https://images.unsplash.com/photo-1589829545856-d10d557cf95f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 0 0 30px 30px;
        }
        
        .hero h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto 30px;
            opacity: 0.95;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 60px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 30px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .card-title {
            color: var(--primary-color);
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--secondary-color);
        }
        
        /* Services Grid */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .service-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .service-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-10px);
        }
        
        .service-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 28px;
        }
        
        .service-card h3 {
            color: var(--dark-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            font-family: 'Roboto', sans-serif;
        }
        
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(46, 106, 177, 0.2);
            outline: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .btn-submit {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
        }
        
        .btn-submit:hover {
            background: linear-gradient(135deg, #0f3a6b, #1d4f87);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* QR Code Section */
        .qrcode-container {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            border: 3px dashed var(--primary-color);
            position: relative;
        }
        
        .qrcode-label {
            display: block;
            margin-top: 20px;
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .qrcode-fallback {
            padding: 30px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 2px solid #dee2e6;
            text-align: center;
            font-family: monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .qrcode-image {
            max-width: 300px;
            height: auto;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }
        
        /* Booking Result */
        .booking-result {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-header {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            text-align: center;
        }
        
        .success-header h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .booking-code-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
            letter-spacing: 3px;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .action-btn {
            padding: 15px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .action-btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .action-btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .action-btn-warning {
            background: var(--warning-color);
            color: #000;
        }
        
        .action-btn-info {
            background: var(--info-color);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Instructions */
        .instructions {
            background: #fff8e1;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border-left: 5px solid var(--warning-color);
        }
        
        .instructions h4 {
            color: #d18f0e;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        /* Sidebar */
        .sidebar-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .sidebar-title {
            color: var(--primary-color);
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .info-list {
            list-style: none;
        }
        
        .info-list li {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .info-list li:last-child {
            border-bottom: none;
        }
        
        .info-list i {
            color: var(--secondary-color);
            margin-top: 3px;
            font-size: 1.1rem;
        }
        
        /* Status Check */
        .status-check {
            background: #e8f4ff;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }
        
        .status-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        /* Previous Submission Button */
        #showPreviousBtn {
            animation: pulse 2s infinite;
            margin-top: 20px;
            width: 100%;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Footer */
        footer {
            background: var(--dark-color);
            color: white;
            padding: 50px 0 20px;
            margin-top: 50px;
        }
        
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .footer-section h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .contact-info p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .footer-links a {
            color: white;
            text-decoration: none;
            display: block;
            margin-bottom: 10px;
            transition: var(--transition);
        }
        
        .footer-links a:hover {
            color: var(--secondary-color);
            transform: translateX(5px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #444;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Loading */
        .spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(26, 77, 140, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideInRight 0.3s ease;
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #20c997);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #e4606d);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--info-color), #3dc8db);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #ffda6a);
            color: #000;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 15px;
            padding: 0 5px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Print Styles */
        @media print {
            header, nav, .sidebar, footer, .btn, .action-buttons,
            .session-warning, #showPreviousBtn {
                display: none !important;
            }
            
            .booking-result {
                display: block !important;
                box-shadow: none;
                border: 2px solid #000;
                margin: 0;
                padding: 20px;
            }
            
            .qrcode-container {
                border: 2px solid #000 !important;
            }
            
            body {
                background: white !important;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
            }
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .mt-30 { margin-top: 30px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .hero h2 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .services-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .booking-code-display {
                font-size: 1.8rem;
                letter-spacing: 2px;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="logo-text">
                        <h1>PTSP LAPAS KELAS IIA BAUBAU</h1>
                        <p>Pelayanan Terpadu Satu Pintu - Lembaga Pemasyarakatan</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="scrollToBooking()">
                        <i class="fas fa-calendar-plus"></i> Daftar Kunjungan
                    </button>
                    <button class="btn btn-outline" onclick="scrollToServices()">
                        <i class="fas fa-concierge-bell"></i> Layanan
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Session Warning (akan muncul jika sudah submit) -->
    <div id="sessionWarning" class="container session-warning" style="display: none;">
        <p><i class="fas fa-info-circle"></i> Anda sudah mendaftar dalam sesi ini. Jika ingin mendaftar lagi, klik tombol "Mulai Sesi Baru" di sidebar.</p>
    </div>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h2>Layanan Kunjungan Online LAPAS Baubau</h2>
            <p>Daftar kunjungan keluarga ke Warga Binaan Pemasyarakatan (WBP) secara online. Cepat, mudah, dan terverifikasi dengan sistem QR Code.</p>
            <button class="btn btn-primary" onclick="scrollToBooking()">
                <i class="fas fa-calendar-check"></i> Daftar Sekarang
            </button>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Left Column -->
            <div class="content-left">
                <!-- Services Section -->
                <section class="card" id="services">
                    <h2 class="card-title">Layanan PTSP Lapas Baubau</h2>
                    <div class="services-grid">
                        <div class="service-card">
                            <div class="service-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3>Kunjungan Keluarga</h3>
                            <p>Registrasi kunjungan keluarga dengan sistem online dan verifikasi QR Code.</p>
                        </div>
                        <div class="service-card">
                            <div class="service-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <h3>Titipan Paket</h3>
                            <p>Pengiriman paket untuk WBP sesuai jadwal dan ketentuan yang berlaku.</p>
                        </div>
                        <div class="service-card">
                            <div class="service-icon">
                                <i class="fas fa-gavel"></i>
                            </div>
                            <h3>Bantuan Hukum</h3>
                            <p>Fasilitas akses bantuan hukum bagi WBP yang membutuhkan.</p>
                        </div>
                        <div class="service-card">
                            <div class="service-icon">
                                <i class="fas fa-briefcase-medical"></i>
                            </div>
                            <h3>Layanan Kesehatan</h3>
                            <p>Pelayanan kesehatan dan pengobatan bagi WBP sesuai standar.</p>
                        </div>
                    </div>
                </section>

                <!-- Booking Form Section -->
                <section class="card" id="booking">
                    <h2 class="card-title">Formulir Pendaftaran Kunjungan</h2>
                    <p class="mb-30">Isi data dengan benar untuk mendapatkan kode booking dan QR Code verifikasi. <strong style="color: var(--danger-color);">Hanya bisa submit sekali per sesi.</strong></p>
                    
                    <!-- Previous Submission Button (akan muncul jika sudah submit) -->
                    <button id="showPreviousBtn" class="btn btn-primary" style="display: none; margin-bottom: 20px;">
                        <i class="fas fa-history"></i> Lihat Pendaftaran Sebelumnya
                    </button>
                    
                    <form id="bookingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nama Lengkap <span style="color: var(--danger-color)">*</span></label>
                                <input type="text" id="nama" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">NIK (16 digit) <span style="color: var(--danger-color)">*</span></label>
                                <input type="text" id="nik" class="form-control" required maxlength="16" pattern="\d{16}" title="Harus 16 digit angka">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">No. Telepon <span style="color: var(--danger-color)">*</span></label>
                                <input type="tel" id="telepon" class="form-control" required pattern="\d{10,15}" title="10-15 digit angka">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="email" class="form-control">
                                <small style="color: #666;">QR Code akan dikirim ke email ini</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Hubungan dengan WBP <span style="color: var(--danger-color)">*</span></label>
                                <select id="hubungan" class="form-control" required>
                                    <option value="">Pilih Hubungan</option>
                                    <option value="Keluarga Inti">Keluarga Inti</option>
                                    <option value="Orang Tua">Orang Tua</option>
                                    <option value="Saudara Kandung">Saudara Kandung</option>
                                    <option value="Pengacara">Pengacara</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tanggal Kunjungan <span style="color: var(--danger-color)">*</span></label>
                                <input type="date" id="tanggal" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nama WBP <span style="color: var(--danger-color)">*</span></label>
                            <input type="text" id="namaWbp" class="form-control" required minlength="3">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Status WBP <span style="color: var(--danger-color)">*</span></label>
                                <select id="statusWbp" class="form-control" required>
                                    <option value="">Pilih Status</option>
                                    <option value="Narapidana">Narapidana</option>
                                    <option value="Tahanan">Tahanan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Jenis Layanan <span style="color: var(--danger-color)">*</span></label>
                                <select id="jenisKunjungan" class="form-control" required>
                                    <option value="">Pilih Layanan</option>
                                    <option value="Kunjungan Keluarga">Kunjungan Keluarga</option>
                                    <option value="Titipan Paket">Titipan Paket</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="spinner" id="loadingSpinner"></div>
                        
                        <button type="submit" class="btn btn-submit" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                            <span id="submitText">Kirim Pendaftaran</span>
                            <span id="loadingText" style="display: none;">Memproses...</span>
                        </button>
                        
                        <div class="text-center mt-20">
                            <small style="color: #666;">
                                <i class="fas fa-info-circle"></i> Data hanya akan tersimpan sekali per sesi. Refresh halaman tidak akan membuat data duplikat.
                            </small>
                        </div>
                    </form>
                    
                    <!-- Booking Result -->
                    <div class="booking-result" id="bookingResult">
                        <div class="success-header">
                            <h3><i class="fas fa-check-circle"></i> Pendaftaran Berhasil!</h3>
                            <p>Data Anda telah tersimpan. Simpan kode booking dan QR Code berikut.</p>
                        </div>
                        
                        <div class="card">
                            <h3 class="text-center mb-20">Tiket Kunjungan Anda</h3>
                            
                            <div class="booking-code-display" id="bookingCodeDisplay">
                                PTSP-BAU-XXXXXX
                            </div>
                            
                            <!-- Copy Button -->
                            <div class="text-center mb-30">
                                <button class="action-btn action-btn-info" onclick="copyBookingCode()" id="copyButton">
                                    <i class="fas fa-copy"></i> Salin Kode Booking
                                </button>
                                <small id="copyFeedback" style="display: none; color: var(--success-color); margin-top: 5px;">
                                    <i class="fas fa-check"></i> Berhasil disalin!
                                </small>
                            </div>
                            
                            <!-- QR Code Section -->
                            <div class="qrcode-container">
                                <h4>QR Code Verifikasi</h4>
                                <!-- QR Code will be generated here -->
                                <div id="qrcodeCanvas"></div>
                                <span class="qrcode-label">
                                    <i class="fas fa-qrcode"></i> SCAN QR CODE INI UNTUK VERIFIKASI CEPAT
                                </span>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="action-btn action-btn-primary" onclick="window.print()">
                                    <i class="fas fa-print"></i> Cetak Tiket
                                </button>
                                <button class="action-btn action-btn-success" onclick="downloadQRCode()">
                                    <i class="fas fa-download"></i> Download QR
                                </button>
                                <button class="action-btn action-btn-warning" onclick="sendQRCodeToEmail()">
                                    <i class="fas fa-envelope"></i> Kirim ke Email
                                </button>
                                <button class="action-btn action-btn-info" onclick="saveToPhone()">
                                    <i class="fas fa-mobile-alt"></i> Simpan di HP
                                </button>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="instructions">
                                <h4><i class="fas fa-info-circle"></i> Instruksi Penting</h4>
                                <ul>
                                    <li>Tunjukkan <strong>QR Code</strong> atau <strong>kode booking</strong> saat tiba</li>
                                    <li>Bawa <strong>KTP asli</strong> untuk verifikasi identitas</li>
                                    <li>Datang <strong>30 menit sebelum</strong> waktu kunjungan</li>
                                    <li>Maksimal <strong>3 orang</strong> per kunjungan</li>
                                    <li>Patuhi protokol kesehatan (masker, jaga jarak)</li>
                                    <li>Simpan bukti pendaftaran ini dengan baik</li>
                                </ul>
                            </div>
                            
                            <!-- Booking Details -->
                            <div id="bookingDetails" class="mt-30"></div>
                            
                            <!-- Session Info -->
                            <div class="text-center mt-30" style="color: #666; font-size: 0.9rem;">
                                <i class="fas fa-shield-alt"></i> Data tersimpan dengan aman. Tidak akan duplikat meski halaman di-refresh.
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Right Column - Sidebar -->
            <div class="sidebar">
                <!-- Important Info -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><i class="fas fa-info-circle"></i> Informasi Penting</h3>
                    <ul class="info-list">
                        <li>
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>Jam Kunjungan</strong><br>
                                Senin-Jumat: 09.00-15.00 WITA
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Syarat Kunjungan</strong><br>
                                Bawa KTP asli, maks 3 orang
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-box"></i>
                            <div>
                                <strong>Titipan Paket</strong><br>
                                Selasa & Kamis, 10.00-12.00 WITA
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-user-shield"></i>
                            <div>
                                <strong>Protokol Kesehatan</strong><br>
                                Wajib masker, cek suhu, jaga jarak
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <div>
                                <strong>Kontak Darurat</strong><br>
                                (0402) 1234567 ext. 102
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-qrcode"></i>
                            <div>
                                <strong>Verifikasi QR Code</strong><br>
                                Petugas akan scan QR untuk verifikasi cepat
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- Session Management -->
                <div class="sidebar-card" id="sessionManagementCard">
                    <h3 class="sidebar-title"><i class="fas fa-redo"></i> Mulai Sesi Baru</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                        Jika ingin mendaftar lagi dalam sesi yang sama.
                    </p>
                    <button class="btn btn-primary" onclick="clearAndStartNewSession()" style="width: 100%;" id="newSessionBtn">
                        <i class="fas fa-plus-circle"></i> Daftar Lagi
                    </button>
                    <div class="text-center mt-15">
                        <small style="color: #888;">
                            <i class="fas fa-user-clock"></i> Sesi aktif: <span id="sessionTimer">0m 0s</span>
                        </small>
                    </div>
                </div>
                
                <!-- Status Check -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><i class="fas fa-search"></i> Cek Status Pendaftaran</h3>
                    <p>Masukkan kode booking untuk mengecek status pendaftaran Anda.</p>
                    
                    <div class="form-group">
                        <input type="text" id="cekKode" class="form-control" placeholder="Masukkan kode booking">
                    </div>
                    <button class="btn btn-primary" onclick="cekStatusBooking()" style="width: 100%;">
                        <i class="fas fa-search"></i> Cek Status
                    </button>
                    
                    <div id="statusResult" class="status-result"></div>
                </div>
                
                <!-- Quick Links -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><i class="fas fa-link"></i> Link Cepat</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="#services" class="btn btn-outline" style="text-align: left; justify-content: flex-start; color: var(--primary-color); border-color: var(--primary-color);">
                            <i class="fas fa-concierge-bell"></i> Layanan
                        </a>
                        <a href="#booking" class="btn btn-outline" style="text-align: left; justify-content: flex-start; color: var(--primary-color); border-color: var(--primary-color);">
                            <i class="fas fa-calendar-plus"></i> Pendaftaran
                        </a>
                        <button class="btn btn-outline" onclick="window.print()" style="text-align: left; justify-content: flex-start; color: var(--primary-color); border-color: var(--primary-color);">
                            <i class="fas fa-print"></i> Cetak Tiket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>PTSP LAPAS Baubau</h3>
                    <p>Sistem Pelayanan Terpadu Satu Pintu Lembaga Pemasyarakatan Kelas IIA Baubau untuk memberikan kemudahan akses layanan informasi dan administrasi.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Kontak Kami</h3>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Jl. Sultan Hasanuddin No. 45, Baubau</p>
                        <p><i class="fas fa-phone"></i> (0402) 1234567</p>
                        <p><i class="fas fa-envelope"></i> ptsp@lapasbaubau.go.id</p>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Tautan</h3>
                    <div class="footer-links">
                        <a href="#services"><i class="fas fa-chevron-right"></i> Layanan WBP</a>
                        <a href="#booking"><i class="fas fa-chevron-right"></i> Pendaftaran Online</a>
                        <a href="#" onclick="window.print()"><i class="fas fa-chevron-right"></i> Cetak Tiket</a>
                        <a href="javascript:void(0)" onclick="cekStatusBooking()"><i class="fas fa-chevron-right"></i> Cek Status</a>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2024 PTSP LAPAS Kelas IIA Baubau. Semua hak dilindungi.</p>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // KONFIGURASI
        // ============================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJR94d6Oq0OwDTYqoCDvYVmpsG955FtAjqPWlXTti0vOjlLNbW9dYOTjBGRfyeLcja/exec'; // GANTI DENGAN URL APPS SCRIPT ANDA
        
        // ============================================
        // VARIABEL GLOBAL
        // ============================================
        let formSubmitted = false;
        let sessionTimerInterval = null;
        let currentSessionId = null;
        
        // ============================================
        // INISIALISASI
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistem PTSP Lapas Baubau dimuat...');
            
            // Inisialisasi session
            initializeSession();
            
            // Set tanggal minimal hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').min = today;
            
            // Set tanggal default besok
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('tanggal').value = tomorrow.toISOString().split('T')[0];
            
            // Cek jika sudah submit dalam session ini
            checkPreviousSubmission();
            
            // Mulai timer session
            startSessionTimer();
            
            // Test koneksi ke server
            testConnection();
            
            console.log('Sistem PTSP Lapas Baubau siap digunakan!');
        });
        
        // ============================================
        // SESSION MANAGEMENT - MENCEGAH DUPLIKASI
        // ============================================
        
        // Generate unique session ID
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Initialize session
        function initializeSession() {
            let sessionId = localStorage.getItem('currentSessionId');
            
            // Generate new session ID jika belum ada
            if (!sessionId) {
                sessionId = generateSessionId();
                localStorage.setItem('currentSessionId', sessionId);
                localStorage.setItem('sessionCreated', new Date().toISOString());
                console.log('Session baru dibuat:', sessionId);
            } else {
                // Cek jika session sudah expired (24 jam)
                const sessionCreated = localStorage.getItem('sessionCreated');
                if (sessionCreated) {
                    const createdDate = new Date(sessionCreated);
                    const now = new Date();
                    const hoursDiff = (now - createdDate) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        // Session expired, buat baru
                        sessionId = generateSessionId();
                        localStorage.setItem('currentSessionId', sessionId);
                        localStorage.setItem('sessionCreated', new Date().toISOString());
                        localStorage.removeItem('lastSubmission');
                        localStorage.removeItem('lastBookingCode');
                        console.log('Session expired, dibuat baru:', sessionId);
                    }
                }
            }
            
            currentSessionId = sessionId;
            return sessionId;
        }
        
        // Cek apakah sudah submit dalam session ini
        function hasSubmittedInThisSession() {
            const sessionId = localStorage.getItem('currentSessionId');
            const lastSubmission = localStorage.getItem('lastSubmission');
            
            if (!sessionId || !lastSubmission) return false;
            
            try {
                const submission = JSON.parse(lastSubmission);
                return submission.sessionId === sessionId && submission.submitted === true;
            } catch (error) {
                return false;
            }
        }
        
        // Cek submission sebelumnya
        function checkPreviousSubmission() {
            if (hasSubmittedInThisSession()) {
                const lastSubmission = JSON.parse(localStorage.getItem('lastSubmission') || '{}');
                
                // Tampilkan warning
                document.getElementById('sessionWarning').style.display = 'block';
                
                // Tampilkan button untuk lihat hasil sebelumnya
                if (lastSubmission.bookingCode) {
                    document.getElementById('showPreviousBtn').style.display = 'block';
                    document.getElementById('showPreviousBtn').onclick = function() {
                        loadPreviousSubmission(lastSubmission.bookingCode);
                    };
                    
                    // Update text button
                    document.getElementById('newSessionBtn').innerHTML = '<i class="fas fa-plus-circle"></i> Daftar Lagi (' + lastSubmission.bookingCode + ')';
                }
                
                // Disable submit button
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check"></i> Sudah Didaftarkan';
                
                console.log('User sudah submit dalam session ini:', lastSubmission.bookingCode);
            }
        }
        
        // Mark session as submitted
        function markSessionAsSubmitted(bookingCode, data) {
            const sessionId = localStorage.getItem('currentSessionId');
            const submissionData = {
                sessionId: sessionId,
                submitted: true,
                bookingCode: bookingCode,
                timestamp: new Date().toISOString(),
                nama: data.nama,
                nik: data.nik,
                tanggal: data.tanggal
            };
            
            localStorage.setItem('lastSubmission', JSON.stringify(submissionData));
            localStorage.setItem('lastBookingCode', bookingCode);
            
            // Update UI
            document.getElementById('sessionWarning').style.display = 'block';
            document.getElementById('showPreviousBtn').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check"></i> Sudah Didaftarkan';
            
            console.log('Session marked as submitted:', bookingCode);
        }
        
        // Clear session data
        function clearSessionSubmission() {
            localStorage.removeItem('lastSubmission');
            localStorage.removeItem('lastBookingCode');
            
            // Update UI
            document.getElementById('sessionWarning').style.display = 'none';
            document.getElementById('showPreviousBtn').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Kirim Pendaftaran';
            document.getElementById('newSessionBtn').innerHTML = '<i class="fas fa-plus-circle"></i> Daftar Lagi';
            
            console.log('Session submission cleared');
        }
        
        // Start session timer
        function startSessionTimer() {
            const sessionCreated = localStorage.getItem('sessionCreated');
            if (!sessionCreated) return;
            
            function updateTimer() {
                const createdDate = new Date(sessionCreated);
                const now = new Date();
                const diffMs = now - createdDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const remainingMins = diffMins % 60;
                
                document.getElementById('sessionTimer').textContent = 
                    `${diffHours > 0 ? diffHours + 'j ' : ''}${remainingMins}m`;
                
                // Jika lebih dari 24 jam, reset session
                if (diffHours >= 24) {
                    initializeSession();
                }
            }
            
            updateTimer();
            sessionTimerInterval = setInterval(updateTimer, 60000); // Update setiap menit
        }
        
        // ============================================
        // FUNGSI UTAMA
        // ============================================
        
        // Test koneksi ke Google Apps Script
        async function testConnection() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=test');
                const data = await response.json();
                console.log('Koneksi berhasil:', data);
                showNotification('Sistem siap digunakan', 'success', 3000);
            } catch (error) {
                console.warn('Koneksi offline, data akan disimpan lokal:', error);
                showNotification('Mode offline aktif. Data akan disimpan sementara.', 'warning', 5000);
            }
        }
        
        // Generate kode booking
        function generateBookingCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'PTSP-BAU-';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Generate QR Code menggunakan Google Charts API
        function generateQRCode(bookingCode, additionalData = {}) {
            try {
                const qrData = {
                    bookingCode: bookingCode,
                    system: "PTSP_LAPAS_BAUBAU",
                    timestamp: new Date().toISOString(),
                    ...additionalData
                };
                
                const qrString = JSON.stringify(qrData);
                
                // Encode data untuk URL
                const encodedData = encodeURIComponent(qrString);
                
                // Buat URL QR Code dari Google Charts API
                const qrCodeUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodedData}&choe=UTF-8&chld=H|2`;
                
                // Tampilkan QR Code
                const qrContainer = document.getElementById('qrcodeCanvas');
                qrContainer.innerHTML = `
                    <img src="${qrCodeUrl}" alt="QR Code Booking ${bookingCode}" class="qrcode-image" id="qrcodeImage">
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <i class="fas fa-sync-alt"></i> QR Code otomatis dikirim ke email
                    </div>
                `;
                
                console.log('QR Code generated for:', bookingCode);
                
                // Simpan QR Code URL untuk download nanti
                window.lastQRCodeUrl = qrCodeUrl;
                window.lastQRCodeData = qrString;
                
                return qrCodeUrl;
                
            } catch (error) {
                console.error('Error generating QR Code:', error);
                // Fallback: Tampilkan kode booking saja
                const qrContainer = document.getElementById('qrcodeCanvas');
                qrContainer.innerHTML = `
                    <div class="qrcode-fallback">
                        <div style="font-size: 20px; margin-bottom: 10px;">${bookingCode}</div>
                        <div style="font-size: 14px; color: #666;">PTSP LAPAS BAUBAU</div>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> Scan manual: ${bookingCode}
                        </div>
                    </div>
                `;
                
                return null;
            }
        }
        
        // ============================================
        // FORM VALIDATION & SUBMISSION
        // ============================================
        
        // Validasi form
        function validateForm() {
            const nama = document.getElementById('nama').value.trim();
            const nik = document.getElementById('nik').value.trim();
            const telepon = document.getElementById('telepon').value.trim();
            const tanggal = document.getElementById('tanggal').value;
            const namaWbp = document.getElementById('namaWbp').value.trim();
            const email = document.getElementById('email').value.trim();
            
            // Validasi NIK (16 digit angka)
            if (!/^\d{16}$/.test(nik)) {
                showNotification('NIK harus 16 digit angka', 'error');
                return false;
            }
            
            // Validasi telepon (min 10 digit)
            if (!/^\d{10,15}$/.test(telepon)) {
                showNotification('Nomor telepon harus 10-15 digit angka', 'error');
                return false;
            }
            
            // Validasi tanggal (minimal besok)
            const today = new Date().toISOString().split('T')[0];
            if (tanggal <= today) {
                showNotification('Tanggal kunjungan harus setelah hari ini', 'error');
                return false;
            }
            
            // Validasi nama WBP
            if (namaWbp.length < 3) {
                showNotification('Nama WBP minimal 3 karakter', 'error');
                return false;
            }
            
            // Validasi email (jika diisi)
            if (email && !isValidEmail(email)) {
                showNotification('Format email tidak valid', 'error');
                return false;
            }
            
            return true;
        }
        
        // Validasi email
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Set flag untuk mencegah multiple submission
            if (formSubmitted) {
                showNotification('Sedang memproses pendaftaran sebelumnya...', 'warning');
                return;
            }
            
            // CEK: Jika sudah submit dalam session ini
            if (hasSubmittedInThisSession()) {
                const lastSubmission = JSON.parse(localStorage.getItem('lastSubmission') || '{}');
                showNotification(
                    `Anda sudah mendaftar dalam sesi ini. Kode: ${lastSubmission.bookingCode}`,
                    'warning',
                    8000
                );
                return;
            }
            
            // Validasi form
            if (!validateForm()) {
                return;
            }
            
            // Ambil data form
            const formData = {
                nama: document.getElementById('nama').value.trim(),
                nik: document.getElementById('nik').value.trim(),
                telepon: document.getElementById('telepon').value.trim(),
                email: document.getElementById('email').value.trim(),
                hubungan: document.getElementById('hubungan').value,
                tanggal: document.getElementById('tanggal').value,
                namaWbp: document.getElementById('namaWbp').value.trim(),
                statusWbp: document.getElementById('statusWbp').value,
                jenisKunjungan: document.getElementById('jenisKunjungan').value,
                tanggalDaftar: new Date().toLocaleString('id-ID'),
                source: 'website_ptsp_baubau',
                sessionId: localStorage.getItem('currentSessionId')
            };
            
            // Generate booking code
            const bookingCode = generateBookingCode();
            
            // Tampilkan loading
            showLoading(true);
            formSubmitted = true;
            
            try {
                // Kirim data ke server
                const response = await submitToServer(formData, bookingCode);
                
                if (response.success) {
                    // MARK SESSION: Tandai sudah submit
                    markSessionAsSubmitted(bookingCode, formData);
                    
                    // Tampilkan hasil
                    displayBookingResult(response, formData);
                    
                    // Reset form dengan session protection
                    resetFormWithSessionProtection();
                    
                    // Kirim notifikasi sukses
                    showNotification(`Pendaftaran berhasil! Kode: ${bookingCode}`, 'success', 8000);
                    
                } else {
                    throw new Error(response.message || 'Gagal menyimpan data');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                
                // Fallback: Simpan di localStorage TAPI dengan session protection
                if (!hasSubmittedInThisSession()) {
                    const saved = saveToLocalStorage(formData, bookingCode);
                    
                    if (saved) {
                        // MARK SESSION: Tandai sudah submit (offline)
                        markSessionAsSubmitted(bookingCode, formData);
                        
                        // Tampilkan hasil offline
                        displayOfflineResult(bookingCode, formData);
                        
                        // Reset form
                        resetFormWithSessionProtection();
                        
                        showNotification(
                            `Data disimpan sementara (offline). Kode: ${bookingCode}`,
                            'warning',
                            10000
                        );
                    } else {
                        showNotification('Gagal menyimpan data. Coba lagi.', 'error');
                    }
                } else {
                    showNotification('Anda sudah mendaftar dalam sesi ini.', 'warning');
                }
                
            } finally {
                // Reset flag dan sembunyikan loading
                formSubmitted = false;
                showLoading(false);
            }
        });
        
        // Kirim data ke server
        async function submitToServer(formData, bookingCode) {
            const payload = new URLSearchParams({
                ...formData,
                bookingCode: bookingCode,
                action: 'submitBooking',
                timestamp: new Date().toISOString(),
                sessionId: formData.sessionId
            });
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: payload
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // ============================================
        // DISPLAY FUNCTIONS
        // ============================================
        
        // Tampilkan hasil booking
        function displayBookingResult(response, formData) {
            const bookingCode = response.bookingCode;
            
            // Update tampilan kode booking
            document.getElementById('bookingCodeDisplay').textContent = bookingCode;
            
            // Generate QR Code
            const qrData = {
                bookingCode: bookingCode,
                nama: formData.nama,
                tanggal: formData.tanggal,
                namaWbp: formData.namaWbp,
                telepon: formData.telepon.substring(formData.telepon.length - 4)
            };
            
            generateQRCode(bookingCode, qrData);
            
            // Update booking details
            const detailsHtml = `
                <h4>Detail Pendaftaran</h4>
                <div style="background: #f8f9fa; padding: 20px; border-radius: var(--border-radius);">
                    <p><strong>Nama:</strong> ${formData.nama}</p>
                    <p><strong>Tanggal Kunjungan:</strong> ${formatDate(formData.tanggal)}</p>
                    <p><strong>WBP:</strong> ${formData.namaWbp}</p>
                    <p><strong>Status:</strong> ${formData.statusWbp}</p>
                    <p><strong>Hubungan:</strong> ${formData.hubungan}</p>
                    <p><strong>No. Telepon:</strong> ${formData.telepon}</p>
                    ${formData.email ? `<p><strong>Email:</strong> ${formData.email}</p>` : ''}
                    <p><strong>Kode Booking:</strong> <code>${bookingCode}</code></p>
                </div>
            `;
            
            document.getElementById('bookingDetails').innerHTML = detailsHtml;
            
            // Tampilkan hasil
            document.getElementById('bookingResult').style.display = 'block';
            
            // Scroll ke hasil
            document.getElementById('bookingResult').scrollIntoView({ behavior: 'smooth' });
            
            // Jika ada email, QR Code otomatis dikirim
            if (formData.email) {
                setTimeout(() => {
                    showNotification(`QR Code sedang dikirim ke ${formData.email}`, 'info', 5000);
                }, 2000);
            }
        }
        
        // Tampilkan hasil offline
        function displayOfflineResult(bookingCode, formData) {
            // Update tampilan
            document.getElementById('bookingCodeDisplay').textContent = bookingCode;
            
            // Generate QR Code
            const qrData = {
                bookingCode: bookingCode,
                nama: formData.nama,
                tanggal: formData.tanggal,
                namaWbp: formData.namaWbp,
                telepon: formData.telepon.substring(formData.telepon.length - 4),
                note: 'OFFLINE_MODE'
            };
            
            generateQRCode(bookingCode, qrData);
            
            // Update booking details dengan catatan offline
            const detailsHtml = `
                <h4>Detail Pendaftaran (Mode Offline)</h4>
                <div style="background: #fff8e1; padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--warning-color);">
                    <p><strong>Status:</strong> <span style="color: var(--warning-color); font-weight: bold;">BELUM DISINKRONKAN</span></p>
                    <p><strong>Nama:</strong> ${formData.nama}</p>
                    <p><strong>Tanggal Kunjungan:</strong> ${formatDate(formData.tanggal)}</p>
                    <p><strong>WBP:</strong> ${formData.namaWbp}</p>
                    <p><strong>Kode Booking:</strong> <code>${bookingCode}</code></p>
                    <p><strong>Catatan:</strong> Data akan dikirim otomatis saat koneksi pulih.</p>
                </div>
            `;
            
            document.getElementById('bookingDetails').innerHTML = detailsHtml;
            
            // Tampilkan hasil
            document.getElementById('bookingResult').style.display = 'block';
            document.getElementById('bookingResult').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Load previous submission
        async function loadPreviousSubmission(bookingCode) {
            try {
                showNotification('Memuat data pendaftaran sebelumnya...', 'info');
                
                // Cek status booking
                const response = await fetch(`${SCRIPT_URL}?action=getBookingStatus&bookingCode=${bookingCode}`);
                const result = await response.json();
                
                if (result.success && result.found) {
                    // Tampilkan data sebelumnya
                    displayBookingResult({
                        success: true,
                        bookingCode: bookingCode,
                        qrData: { bookingCode: bookingCode }
                    }, result.data);
                    
                    showNotification('Data pendaftaran sebelumnya berhasil dimuat', 'success');
                } else {
                    // Cek di localStorage
                    const bookings = JSON.parse(localStorage.getItem('ptspBookings') || '[]');
                    const localBooking = bookings.find(b => b.bookingCode === bookingCode);
                    
                    if (localBooking) {
                        displayOfflineResult(bookingCode, localBooking);
                        showNotification('Data ditemukan di penyimpanan lokal', 'info');
                    } else {
                        throw new Error('Data tidak ditemukan');
                    }
                }
                
            } catch (error) {
                console.error('Error loading previous:', error);
                showNotification('Gagal memuat data sebelumnya', 'error');
            }
        }
        
        // ============================================
        // ACTION BUTTONS
        // ============================================
        
        // Copy booking code to clipboard
        function copyBookingCode() {
            const bookingCode = document.getElementById('bookingCodeDisplay').textContent;
            
            navigator.clipboard.writeText(bookingCode).then(() => {
                // Tampilkan feedback
                const copyFeedback = document.getElementById('copyFeedback');
                copyFeedback.style.display = 'block';
                
                // Update button text
                const copyButton = document.getElementById('copyButton');
                copyButton.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
                copyButton.style.background = 'var(--success-color)';
                
                // Reset setelah 3 detik
                setTimeout(() => {
                    copyFeedback.style.display = 'none';
                    copyButton.innerHTML = '<i class="fas fa-copy"></i> Salin Kode Booking';
                    copyButton.style.background = '';
                }, 3000);
                
                showNotification(`Kode booking "${bookingCode}" disalin ke clipboard`, 'success');
                
            }).catch(err => {
                console.error('Copy failed:', err);
                // Fallback untuk browser lama
                const textArea = document.createElement('textarea');
                textArea.value = bookingCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showNotification(`Kode "${bookingCode}" disalin`, 'success');
            });
        }
        
        // Download QR Code
        function downloadQRCode() {
            try {
                const bookingCode = document.getElementById('bookingCodeDisplay').textContent;
                
                if (window.lastQRCodeUrl) {
                    // Download gambar QR Code
                    const link = document.createElement('a');
                    link.download = `QRCode-${bookingCode}.png`;
                    link.href = window.lastQRCodeUrl;
                    link.click();
                    
                    showNotification(`QR Code ${bookingCode} berhasil didownload`, 'success');
                    
                } else {
                    // Fallback: Buat gambar dari canvas
                    const qrImage = document.getElementById('qrcodeImage');
                    if (qrImage) {
                        const link = document.createElement('a');
                        link.download = `QRCode-${bookingCode}.png`;
                        link.href = qrImage.src;
                        link.click();
                    } else {
                        throw new Error('QR Code tidak tersedia');
                    }
                }
                
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Ambil screenshot halaman untuk menyimpan QR Code', 'info');
            }
        }
        
        // Kirim QR Code ke email
        async function sendQRCodeToEmail() {
            const bookingCode = document.getElementById('bookingCodeDisplay').textContent;
            
            // Ambil email dari form atau minta input
            let email = document.getElementById('email').value.trim();
            
            if (!email) {
                // Minta email jika belum ada
                const userEmail = prompt('Masukkan email untuk mengirim QR Code:', '');
                if (!userEmail || !isValidEmail(userEmail)) {
                    showNotification('Email tidak valid', 'error');
                    return;
                }
                email = userEmail;
            }
            
            showNotification(`Mengirim QR Code ke ${email}...`, 'info');
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'sendQRCodeEmail',
                        bookingCode: bookingCode,
                        email: email
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`QR Code berhasil dikirim ke ${email}`, 'success');
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Email error:', error);
                showNotification('Gagal mengirim email. Coba lagi nanti.', 'error');
            }
        }
        
        // Simpan ke HP
        function saveToPhone() {
            const bookingCode = document.getElementById('bookingCodeDisplay').textContent;
            
            // Cek apakah Web Share API tersedia
            if (navigator.share) {
                navigator.share({
                    title: `Tiket LAPAS Baubau - ${bookingCode}`,
                    text: `Kode booking: ${bookingCode}. Tunjukkan QR Code saat kunjungan.`,
                    url: window.location.href
                }).then(() => {
                    showNotification('Tiket berhasil dibagikan', 'success');
                }).catch(error => {
                    console.log('Share cancelled:', error);
                    downloadQRCode(); // Fallback ke download
                });
            } else {
                // Fallback: Download QR Code
                downloadQRCode();
            }
        }
        
        // Clear session dan mulai baru
        function clearAndStartNewSession() {
            if (confirm('Mulai sesi baru? Anda akan bisa mendaftar lagi, tetapi data pendaftaran sebelumnya tetap aman.')) {
                // Clear session data
                clearSessionSubmission();
                
                // Reset form
                resetForm();
                
                // Hide booking result jika sedang ditampilkan
                document.getElementById('bookingResult').style.display = 'none';
                
                showNotification('Sesi baru dimulai. Silakan isi formulir pendaftaran.', 'success');
                
                // Scroll ke form
                document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // ============================================
        // STATUS CHECK
        // ============================================
        
        // Cek status booking
        async function cekStatusBooking() {
            let kode = document.getElementById('cekKode').value.trim();
            const statusResult = document.getElementById('statusResult');
            
            // Jika kode kosong, coba ambil dari last submission
            if (!kode) {
                const lastSubmission = JSON.parse(localStorage.getItem('lastSubmission') || '{}');
                if (lastSubmission.bookingCode) {
                    kode = lastSubmission.bookingCode;
                    document.getElementById('cekKode').value = kode;
                } else {
                    showNotification('Masukkan kode booking terlebih dahulu', 'error');
                    return;
                }
            }
            
            // Clear previous result
            statusResult.style.display = 'none';
            statusResult.className = 'status-result';
            statusResult.innerHTML = '';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getBookingStatus&bookingCode=${encodeURIComponent(kode)}`);
                const result = await response.json();
                
                if (result.success && result.found) {
                    statusResult.className = 'status-result status-success';
                    statusResult.innerHTML = `
                        <h4><i class="fas fa-check-circle"></i> Data Ditemukan</h4>
                        <p><strong>Kode Booking:</strong> ${result.data['Kode Booking'] || kode}</p>
                        <p><strong>Nama:</strong> ${result.data['Nama Lengkap'] || 'Tidak tersedia'}</p>
                        <p><strong>Tanggal Kunjungan:</strong> ${formatDate(result.data['Tanggal Kunjungan'])}</p>
                        <p><strong>Status:</strong> <span style="background: #c3e6cb; color: #155724; padding: 3px 10px; border-radius: 3px; font-weight: bold;">${result.data.Status || 'MENUNGGU'}</span></p>
                        <p><strong>Email Terkirim:</strong> ${result.data['Email Terkirim'] || 'Tidak ada'}</p>
                        <p><strong>Tanggal Daftar:</strong> ${result.data.Timestamp || 'Tidak tersedia'}</p>
                    `;
                } else {
                    statusResult.className = 'status-result status-error';
                    statusResult.innerHTML = `
                        <h4><i class="fas fa-exclamation-circle"></i> Tidak Ditemukan</h4>
                        <p>Kode booking <strong>${kode}</strong> tidak ditemukan.</p>
                        <p>Pastikan kode yang dimasukkan benar.</p>
                    `;
                }
                
                statusResult.style.display = 'block';
                
            } catch (error) {
                console.error('Status check error:', error);
                
                // Cek di localStorage
                const bookings = JSON.parse(localStorage.getItem('ptspBookings') || '[]');
                const localBooking = bookings.find(b => b.bookingCode === kode);
                
                if (localBooking) {
                    statusResult.className = 'status-result status-success';
                    statusResult.innerHTML = `
                        <h4><i class="fas fa-database"></i> Data Ditemukan (Lokal)</h4>
                        <p><strong>Kode Booking:</strong> ${localBooking.bookingCode}</p>
                        <p><strong>Nama:</strong> ${localBooking.nama}</p>
                        <p><strong>Tanggal Kunjungan:</strong> ${formatDate(localBooking.tanggal)}</p>
                        <p><strong>Status:</strong> <span style="background: #fff3cd; color: #856404; padding: 3px 10px; border-radius: 3px;">${localBooking.synced ? 'TERSINKRON' : 'BELUM SYNC'}</span></p>
                        <p><small>Data ini tersimpan di browser Anda.</small></p>
                    `;
                } else {
                    statusResult.className = 'status-result status-error';
                    statusResult.innerHTML = `
                        <h4><i class="fas fa-exclamation-triangle"></i> Server Error</h4>
                        <p>Gagal menghubungi server. Silakan coba lagi nanti.</p>
                        <p>Error: ${error.message}</p>
                    `;
                }
                
                statusResult.style.display = 'block';
            }
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        // Format tanggal
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date)) return dateString;
                
                return date.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }
        
        // Tampilkan loading
        function showLoading(show) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (show) {
                submitBtn.disabled = true;
                submitText.style.display = 'none';
                loadingText.style.display = 'inline';
                spinner.style.display = 'block';
            } else {
                if (!hasSubmittedInThisSession()) {
                    submitBtn.disabled = false;
                }
                submitText.style.display = 'inline';
                loadingText.style.display = 'none';
                spinner.style.display = 'none';
            }
        }
        
        // Reset form
        function resetForm() {
            // Reset semua field
            const fields = ['nama', 'nik', 'telepon', 'email', 'namaWbp'];
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) element.value = '';
            });
            
            // Reset select fields
            const selects = ['hubungan', 'statusWbp', 'jenisKunjungan'];
            selects.forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) element.selectedIndex = 0;
            });
            
            // Set tanggal default besok
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('tanggal').value = tomorrow.toISOString().split('T')[0];
        }
        
        // Reset form dengan session protection
        function resetFormWithSessionProtection() {
            // Reset form
            resetForm();
            
            // Focus ke field pertama
            document.getElementById('nama').focus();
        }
        
        // Simpan ke localStorage
        function saveToLocalStorage(formData, bookingCode) {
            try {
                // CEK: Jangan simpan jika sudah ada dalam session ini
                if (hasSubmittedInThisSession()) {
                    console.log('Session already has submission, skipping local save');
                    return false;
                }
                
                const bookings = JSON.parse(localStorage.getItem('ptspBookings') || '[]');
                
                // Cek duplikasi NIK untuk tanggal yang sama di localStorage
                const isDuplicate = bookings.some(booking => 
                    booking.nik === formData.nik && 
                    booking.tanggal === formData.tanggal &&
                    !booking.synced
                );
                
                if (isDuplicate) {
                    console.log('Duplicate found in localStorage, skipping');
                    return false;
                }
                
                const bookingRecord = {
                    ...formData,
                    bookingCode: bookingCode,
                    savedAt: new Date().toISOString(),
                    synced: false,
                    sessionId: formData.sessionId
                };
                
                bookings.push(bookingRecord);
                localStorage.setItem('ptspBookings', JSON.stringify(bookings));
                
                console.log('Saved to localStorage:', bookingRecord);
                return true;
                
            } catch (error) {
                console.error('LocalStorage error:', error);
                return false;
            }
        }
        
        // Auto sync data dari localStorage
        async function syncLocalData() {
            try {
                const bookings = JSON.parse(localStorage.getItem('ptspBookings') || '[]');
                const unsynced = bookings.filter(b => !b.synced);
                
                if (unsynced.length === 0) return;
                
                console.log(`Syncing ${unsynced.length} local records...`);
                
                for (const booking of unsynced) {
                    try {
                        // Cek duplikasi di server sebelum sync
                        const checkResponse = await fetch(
                            `${SCRIPT_URL}?action=getBookingStatus&bookingCode=${booking.bookingCode}`
                        );
                        const checkResult = await checkResponse.json();
                        
                        if (checkResult.success && checkResult.found) {
                            // Data sudah ada di server, mark as synced
                            console.log(`Booking ${booking.bookingCode} already exists on server`);
                            booking.synced = true;
                            continue;
                        }
                        
                        // Kirim data ke server
                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                ...booking,
                                action: 'submitBooking',
                                isResync: 'true',
                                sessionId: booking.sessionId || ''
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                booking.synced = true;
                                booking.syncedAt = new Date().toISOString();
                                console.log(`Synced: ${booking.bookingCode}`);
                            }
                        }
                    } catch (syncError) {
                        console.error('Sync failed for', booking.bookingCode, syncError);
                    }
                }
                
                // Hapus data yang sudah disinkron dari localStorage (simpan hanya 7 hari)
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const filteredBookings = bookings.filter(booking => {
                    if (booking.synced) {
                        const syncedAt = new Date(booking.syncedAt || booking.savedAt);
                        return syncedAt > oneWeekAgo; // Simpan data synced hanya 7 hari
                    }
                    return true; // Simpan semua unsynced
                });
                
                localStorage.setItem('ptspBookings', JSON.stringify(filteredBookings));
                
                console.log('Local storage cleaned. Remaining:', filteredBookings.length);
                
            } catch (error) {
                console.error('Auto-sync error:', error);
            }
        }
        
        // Tampilkan notifikasi
        function showNotification(message, type = 'info', duration = 5000) {
            // Hapus notifikasi lama
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(note => {
                note.style.opacity = '0';
                setTimeout(() => {
                    if (note.parentNode) note.parentNode.removeChild(note);
                }, 300);
            });
            
            // Buat notifikasi baru
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto hapus
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, duration);
        }
        
        // Scroll functions
        function scrollToBooking() {
            document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
        }
        
        function scrollToServices() {
            document.getElementById('services').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Inisialisasi localStorage
        if (!localStorage.getItem('ptspBookings')) {
            localStorage.setItem('ptspBookings', JSON.stringify([]));
        }
        
        // Auto sync setiap 30 detik jika online
        setInterval(() => {
            if (navigator.onLine) {
                syncLocalData();
            }
        }, 30000);
        
        // Sync saat online
        window.addEventListener('online', syncLocalData);
        
        // Cegah accidental refresh setelah submit
        window.addEventListener('beforeunload', function(e) {
            if (formSubmitted && !hasSubmittedInThisSession()) {
                const message = 'Anda belum menyelesaikan pendaftaran. Yakin ingin meninggalkan halaman?';
                e.returnValue = message;
                return message;
            }
        });
        
        console.log('Sistem PTSP Lapas Baubau berhasil dimuat!');
    </script>
</body>
</html>
